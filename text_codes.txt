#include <WiFi.h>
#include <WiFiClient.h>
#include <ESP32Servo.h>
#include "Adafruit_MQTT.h"
#include "Adafruit_MQTT_Client.h"


//Power codes declaration
const int voltagePin = 33; 
const int analogInPin = 35; 
int sensorValue; 
float voltage;
float bat_percentage;
const int CurrentPin=27;


Servo myservo;
 int LDR1 = 32;
 int LDR2 = 34; 

int Spoint = 90;


#define WLAN_SSID       "mufasa1"   
#define WLAN_PASS       "vlad1111"   


#define AIO_SERVER      "io.adafruit.com"
#define AIO_SERVERPORT  1883 
#define IO_USERNAME  "Manzi_Vlad"
#define IO_KEY       "aio_vLpo75KzROD8qgGGvn2Y65oAQZnk"      


WiFiClient client;
Adafruit_MQTT_Client mqtt(&client, AIO_SERVER, AIO_SERVERPORT, IO_USERNAME, IO_KEY);


Adafruit_MQTT_Subscribe Sys_switch = Adafruit_MQTT_Subscribe(&mqtt, IO_USERNAME "/feeds/LED1");
Adafruit_MQTT_Publish LED2= Adafruit_MQTT_Publish(&mqtt, IO_USERNAME "/feeds/LED2");
Adafruit_MQTT_Publish LED3 = Adafruit_MQTT_Publish(&mqtt, IO_USERNAME "/feeds/LED3");
Adafruit_MQTT_Publish LED4 = Adafruit_MQTT_Publish(&mqtt, IO_USERNAME "/feeds/LED4");
Adafruit_MQTT_Publish dim2= Adafruit_MQTT_Publish(&mqtt, IO_USERNAME "/feeds/dim2");



void MQTT_connect();



void setup() {

 pinMode(voltagePin,INPUT);
 pinMode(analogInPin,INPUT);
 pinMode(CurrentPin,INPUT);
 pinMode(LDR1,INPUT);
 pinMode(LDR2,INPUT
 );
  
  Serial.begin(115200);
  myservo.attach(14);
myservo.write(Spoint);
delay(1000);
  

  Serial.println(F("Adafruit MQTT password "));

 
  Serial.print("Connecting to ");
  Serial.println(WLAN_SSID);
  WiFi.begin(WLAN_SSID, WLAN_PASS);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nWiFi connected");
  Serial.print("IP address: ");
  Serial.println(WiFi.localIP());
}

void loop() {
  MQTT_connect();

 
  
   int ldr1 = analogRead(LDR1);
  int ldr2 = analogRead(LDR2);
  ldr2=ldr2+550;
  int Value1 = abs(ldr1-ldr2);
  int Value2 = abs(ldr2-ldr1);



  if((Value1<1)||(Value2<1)){
    
  }

  else{
    if (ldr1>ldr2){
      Spoint=--Spoint;
    }

    if (ldr1<ldr2){
      Spoint=++Spoint;
    }
    
    Spoint = constrain(Spoint, 0, 180);


    }
     myservo.write(Spoint);
      delay(300);
            Serial.println(ldr1);
      Serial.println(ldr2);
      Serial.print("Degrees");
      Serial.println(Spoint); 

      //The power codes

      
unsigned int x=0;
float AcsValue=analogRead(CurrentPin);

float RealCurrent = map (AcsValue,1550,3550,-20,20);    
  
  delay (3); 


  

Serial.print("The current is: "); 
Serial.println(RealCurrent);


 float Range = analogRead(voltagePin); 
 float Vadc  = Range * 3.3 / 4095; 
 float Vin = Vadc/0.33 ;
  
   Serial.print("Solar panel Voltage: ");
   Serial.println(Vin); 

   float power=Vin * RealCurrent;
   Serial.print("Total power: ");
   Serial.print(power);         
Serial.println(".");

delay(10);

sensorValue = analogRead(analogInPin);

delay(5);
  voltage = (((sensorValue * 3.3) / 4095) * 2 ); 
  bat_percentage = mapfloat(voltage, 3.0, 4.2, 0, 100); 

    
 
  if (bat_percentage >= 100)
  {
    bat_percentage = 100;
  }
  if (bat_percentage <= 0)
  {
    bat_percentage = 1;
  }
 
  Serial.print("Analog Value = ");
  Serial.print(sensorValue);
  Serial.print("\t Output Voltage = ");
  Serial.print(voltage);
  Serial.print("\t Battery Percentage = ");
  Serial.println(bat_percentage);

  delay(1000);



static unsigned long lastTime = 0;
if (millis() - lastTime > 7000) { 
    LED2.publish(Vin);       
    LED3.publish(RealCurrent);
    LED4.publish(bat_percentage); 
    dim2.publish(power);      
    lastTime = millis();
}

}


float mapfloat(float x, float in_min, float in_max, float out_min, float out_max)
{
  return (x - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
}

void MQTT_connect() {
  int8_t ret;

  if (mqtt.connected()) {
    return;
  }

  Serial.print("Connecting to MQTT... ");
  uint8_t retries = 3;


  while ((ret = mqtt.connect()) != 0) { 
    Serial.println(mqtt.connectErrorString(ret));
    Serial.println("Retrying MQTT connection in 5 seconds...");
    mqtt.disconnect();
    delay(1000);
    retries--;
    if (retries == 0) {
      while (1); 
    }
  }
  Serial.println("MQTT Connected!");
}